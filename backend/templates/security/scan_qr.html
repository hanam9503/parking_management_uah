{% extends 'base.html' %}

{% block title %}Qu√©t QR Code{% endblock %}

{% block extra_css %}
<!-- Th∆∞ vi·ªán html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto max-w-4xl">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'security_dashboard' %}" 
           class="text-blue-600 hover:underline mb-2 inline-block">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i Dashboard
        </a>
        <h1 class="text-3xl font-bold">
            <i class="fas fa-qrcode"></i> Qu√©t QR Code
        </h1>
        <p class="text-gray-600">S·ª≠ d·ª•ng camera ƒë·ªÉ qu√©t m√£ QR tr√™n xe</p>
    </div>

    <!-- Status Bar -->
    <div id="status-bar" class="bg-blue-100 border-l-4 border-blue-500 p-4 mb-6 rounded hidden">
        <p class="text-blue-700" id="status-message">
            <i class="fas fa-info-circle"></i> ƒêang kh·ªüi ƒë·ªông camera...
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Camera Scanner -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-camera"></i> Camera Scanner
            </h2>

            <!-- Camera Select -->
            <div class="mb-4" id="camera-select-container" style="display: none;">
                <label class="block text-sm font-medium mb-2">Ch·ªçn camera:</label>
                <select id="camera-select" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">-- Ch·ªçn camera --</option>
                </select>
            </div>

            <!-- Scanner Container -->
            <div id="qr-reader" class="w-full rounded-lg overflow-hidden bg-black" style="height: 400px;">
                <!-- Camera feed s·∫Ω render ·ªü ƒë√¢y -->
            </div>

            <!-- Control Buttons -->
            <div class="mt-4 grid grid-cols-2 gap-3">
                <button id="btn-start" onclick="startScanner()" 
                        class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold">
                    <i class="fas fa-play"></i> B·∫≠t Camera
                </button>
                <button id="btn-stop" onclick="stopScanner()" 
                        class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold" disabled>
                    <i class="fas fa-stop"></i> T·∫Øt Camera
                </button>
            </div>

            <!-- Manual Input Fallback -->
            <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                <p class="text-sm text-blue-800 mb-2">
                    <i class="fas fa-keyboard"></i> Kh√¥ng qu√©t ƒë∆∞·ª£c? Nh·∫≠p th·ªß c√¥ng:
                </p>
                <div class="flex gap-2">
                    <input type="text" id="manual-qr-input" 
                           placeholder="VEHICLE_ID|LICENSE_PLATE"
                           class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button onclick="processManualInput()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        X·ª≠ l√Ω
                    </button>
                </div>
            </div>
        </div>

        <!-- Results & Instructions -->
        <div class="space-y-6">
            <!-- Scan Result -->
            <div id="scan-result" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-check-circle text-green-600"></i> K·∫øt qu·∫£ qu√©t
                </h3>
                <div id="result-content" class="space-y-3">
                    <!-- Result will be injected here -->
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-book"></i> H∆∞·ªõng d·∫´n
                </h2>
                <div class="space-y-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">1</div>
                        <div>
                            <h3 class="font-semibold mb-1">B·∫≠t camera</h3>
                            <p class="text-sm text-gray-600">Nh·∫•n "B·∫≠t Camera" v√† cho ph√©p truy c·∫≠p camera khi tr√¨nh duy·ªát y√™u c·∫ßu.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold">2</div>
                        <div>
                            <h3 class="font-semibold mb-1">Qu√©t m√£ QR</h3>
                            <p class="text-sm text-gray-600">ƒê∆∞a m√£ QR tr√™n xe v√†o gi·ªØa khung h√¨nh. Gi·ªØ kho·∫£ng c√°ch 10-30cm. H·ªá th·ªëng t·ª± ƒë·ªông x·ª≠ l√Ω!</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold">3</div>
                        <div>
                            <h3 class="font-semibold mb-1">X√°c nh·∫≠n k·∫øt qu·∫£</h3>
                            <p class="text-sm text-gray-600">H·ªá th·ªëng t·ª± ƒë·ªông ph√°t hi·ªán xe ngo√†i/trong b√£i v√† th·ª±c hi·ªán CHECK-IN/OUT. Xem k·∫øt qu·∫£ ngay!</p>
                        </div>
                    </div>
                </div>

                <!-- Tips -->
                <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                    <h3 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-lightbulb"></i> M·∫πo s·ª≠ d·ª•ng
                    </h3>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>‚úì ƒê·∫£m b·∫£o m√£ QR kh√¥ng b·ªã nhƒÉn, r√°ch</li>
                        <li>‚úì Qu√©t ·ªü n∆°i c√≥ √°nh s√°ng ƒë·ªß</li>
                        <li>‚úì Gi·ªØ ƒëi·ªán tho·∫°i/m√°y qu√©t ·ªïn ƒë·ªãnh</li>
                        <li>‚úì N·∫øu l·ªói, th·ª≠ nh·∫≠p bi·ªÉn s·ªë th·ªß c√¥ng</li>
                    </ul>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-blue-100 rounded-lg p-3 text-center">
                    <i class="fas fa-qrcode text-2xl text-blue-600 mb-1"></i>
                    <p class="text-xl font-bold text-blue-600" id="scan-count">0</p>
                    <p class="text-xs text-blue-700">Qu√©t h√¥m nay</p>
                </div>
                <div class="bg-green-100 rounded-lg p-3 text-center">
                    <i class="fas fa-check text-2xl text-green-600 mb-1"></i>
                    <p class="text-xl font-bold text-green-600" id="success-count">0</p>
                    <p class="text-xs text-green-700">Th√†nh c√¥ng</p>
                </div>
                <div class="bg-red-100 rounded-lg p-3 text-center">
                    <i class="fas fa-times text-2xl text-red-600 mb-1"></i>
                    <p class="text-xl font-bold text-red-600" id="fail-count">0</p>
                    <p class="text-xs text-red-700">Th·∫•t b·∫°i</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entry Type Modal -->
<div id="entry-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6">
        <h3 class="text-2xl font-bold mb-4">Ch·ªçn lo·∫°i giao d·ªãch</h3>
        <div id="qr-info" class="mb-4 p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-600">M√£ QR:</p>
            <p class="font-mono text-sm break-all" id="modal-qr-data">--</p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="processEntry('checkin')" 
                    class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-lg font-bold">
                <i class="fas fa-sign-in-alt"></i><br>CHECK-IN
            </button>
            <button onclick="processEntry('checkout')" 
                    class="bg-red-600 hover:bg-red-700 text-white py-4 rounded-lg font-bold">
                <i class="fas fa-sign-out-alt"></i><br>CHECK-OUT
            </button>
        </div>
        <button onclick="closeModal()" 
                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg">
            H·ªßy
        </button>
    </div>
</div>

<script>
    let html5QrcodeScanner = null;
    let currentQrData = null;
    let stats = { scan: 0, success: 0, fail: 0 };

    // Initialize scanner
    function initScanner() {
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            disableFlip: false
        };

        html5QrcodeScanner = new Html5Qrcode("qr-reader");

        // Get available cameras
        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length > 0) {
                const select = document.getElementById('camera-select');
                const container = document.getElementById('camera-select-container');
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.text = camera.label || `Camera ${index + 1}`;
                    select.appendChild(option);
                });

                if (cameras.length > 1) {
                    container.style.display = 'block';
                }

                showStatus('Camera s·∫µn s√†ng. Nh·∫•n "B·∫≠t Camera" ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'success');
            }
        }).catch(err => {
            showStatus('Kh√¥ng t√¨m th·∫•y camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.', 'error');
            console.error('Camera error:', err);
        });
    }

    async function startScanner() {
        const cameraSelect = document.getElementById('camera-select');
        const cameraId = cameraSelect.value || { facingMode: "environment" };

        try {
            await html5QrcodeScanner.start(
                cameraId,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                onScanError
            );

            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            showStatus('Camera ƒëang ho·∫°t ƒë·ªông. Qu√©t m√£ QR...', 'info');
        } catch (err) {
            showStatus('L·ªói kh·ªüi ƒë·ªông camera: ' + err, 'error');
            console.error('Start error:', err);
        }
    }

    async function stopScanner() {
        try {
            await html5QrcodeScanner.stop();
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            showStatus('Camera ƒë√£ t·∫Øt', 'info');
        } catch (err) {
            console.error('Stop error:', err);
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log('QR Scanned:', decodedText);
        
        // Update stats
        stats.scan++;
        updateStats();

        // Stop scanner
        stopScanner();

        // üéØ Auto-process without modal
        currentQrData = decodedText;
        autoProcessQR(decodedText);
    }

    function onScanError(error) {
        // Ignore scan errors (too noisy)
        // console.warn('Scan error:', error);
    }

    function closeModal() {
        document.getElementById('entry-modal').classList.add('hidden');
        currentQrData = null;
        // Restart scanner
        startScanner();
    }

    async function processEntry(entryType) {
        if (!currentQrData) return;

        const resultDiv = document.getElementById('result-content');
        resultDiv.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...</p>';
        document.getElementById('scan-result').classList.remove('hidden');
        closeModal();

        try {
            // Call backend API
            const response = await fetch('{% url "camera_api_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    qr_data: currentQrData,
                    entry_type: entryType
                })
            });

            const result = await response.json();

            if (result.success) {
                stats.success++;
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800 font-bold mb-2">
                            <i class="fas fa-check-circle"></i> ${result.message}
                        </p>
                        ${result.vehicle_info ? `
                            <div class="text-sm text-gray-700 space-y-1">
                                <p><strong>Bi·ªÉn s·ªë:</strong> ${result.vehicle_info.license_plate}</p>
                                <p><strong>Lo·∫°i xe:</strong> ${result.vehicle_info.vehicle_type}</p>
                                <p><strong>Gi·∫£ng vi√™n:</strong> ${result.vehicle_info.teacher}</p>
                                ${result.detected_plate ? `<p><strong>Ph√°t hi·ªán:</strong> ${result.detected_plate}</p>` : ''}
                                ${result.confidence ? `<p><strong>ƒê·ªô tin c·∫≠y:</strong> ${(result.confidence * 100).toFixed(1)}%</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                stats.fail++;
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800 font-bold">
                            <i class="fas fa-times-circle"></i> ${result.message}
                        </p>
                    </div>
                `;
            }
        } catch (error) {
            stats.fail++;
            resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800 font-bold">
                        <i class="fas fa-exclamation-triangle"></i> L·ªói k·∫øt n·ªëi: ${error.message}
                    </p>
                </div>
            `;
        }

        updateStats();
        
        // Auto hide after 5s and restart scanner
        setTimeout(() => {
            document.getElementById('scan-result').classList.add('hidden');
            startScanner();
        }, 5000);
    }

    // üéØ New: Auto-process QR without modal - smart entry type detection
    async function autoProcessQR(qrData) {
        const resultDiv = document.getElementById('result-content');
        resultDiv.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch v√† x·ª≠ l√Ω...</p>';
        document.getElementById('scan-result').classList.remove('hidden');

        try {
            // Call backend API with 'auto' entry_type
            const response = await fetch('{% url "camera_api_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    qr_data: qrData,
                    entry_type: 'auto'  // üîÑ Smart auto-detection
                })
            });

            const result = await response.json();

            if (result.success) {
                stats.success++;
                const actionText = result.message.includes('Check-out') ? '‚úÖ CHECK-OUT th√†nh c√¥ng!' : '‚úÖ CHECK-IN th√†nh c√¥ng!';
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800 font-bold mb-2">
                            <i class="fas fa-check-circle"></i> ${actionText}
                        </p>
                        ${result.vehicle_info ? `
                            <div class="text-sm text-gray-700 space-y-1">
                                <p><strong>Bi·ªÉn s·ªë:</strong> ${result.vehicle_info.license_plate}</p>
                                <p><strong>Lo·∫°i xe:</strong> ${result.vehicle_info.vehicle_type}</p>
                                <p><strong>Gi·∫£ng vi√™n:</strong> ${result.vehicle_info.teacher}</p>
                                ${result.detected_plate && result.detected_plate !== 'UNDETECTED' ? `<p><strong>Camera:</strong> ${result.detected_plate}</p>` : ''}
                                ${result.confidence ? `<p><strong>ƒê·ªô tin c·∫≠y:</strong> ${(result.confidence * 100).toFixed(1)}%</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                stats.fail++;
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800 font-bold mb-2">
                            <i class="fas fa-times-circle"></i> ${result.message || 'X·ª≠ l√Ω th·∫•t b·∫°i'}
                        </p>
                        ${result.error_code ? `
                            <p class="text-sm text-red-700 mt-2">M√£ l·ªói: ${result.error_code}</p>
                        ` : ''}
                        <button onclick="manualOverride('${qrData}')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            Nh·∫≠p th·ªß c√¥ng
                        </button>
                    </div>
                `;
            }
        } catch (error) {
            stats.fail++;
            resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800 font-bold">
                        <i class="fas fa-exclamation-triangle"></i> L·ªói k·∫øt n·ªëi: ${error.message}
                    </p>
                </div>
            `;
        }

        updateStats();
        
        // Auto hide after 5s and restart scanner
        setTimeout(() => {
            document.getElementById('scan-result').classList.add('hidden');
            startScanner();
        }, 5000);
    }

    // Manual override option
    function manualOverride(qrData) {
        currentQrData = qrData;
        document.getElementById('modal-qr-data').textContent = qrData;
        document.getElementById('entry-modal').classList.remove('hidden');
    }

    function processManualInput() {
        const input = document.getElementById('manual-qr-input').value.trim();
        if (!input) {
            alert('Vui l√≤ng nh·∫≠p m√£ QR');
            return;
        }

        currentQrData = input;
        document.getElementById('modal-qr-data').textContent = input;
        document.getElementById('entry-modal').classList.remove('hidden');
    }

    function showStatus(message, type) {
        const statusBar = document.getElementById('status-bar');
        const statusMessage = document.getElementById('status-message');
        
        statusBar.className = 'p-4 mb-6 rounded';
        
        if (type === 'error') {
            statusBar.className += ' bg-red-100 border-l-4 border-red-500';
            statusMessage.className = 'text-red-700';
            statusMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        } else if (type === 'success') {
            statusBar.className += ' bg-green-100 border-l-4 border-green-500';
            statusMessage.className = 'text-green-700';
            statusMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        } else {
            statusBar.className += ' bg-blue-100 border-l-4 border-blue-500';
            statusMessage.className = 'text-blue-700';
            statusMessage.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        }
        
        statusBar.classList.remove('hidden');
        
        // Auto hide after 5s
        setTimeout(() => {
            statusBar.classList.add('hidden');
        }, 5000);
    }

    function updateStats() {
        document.getElementById('scan-count').textContent = stats.scan;
        document.getElementById('success-count').textContent = stats.success;
        document.getElementById('fail-count').textContent = stats.fail;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize on load
    window.addEventListener('load', initScanner);
</script>
{% endblock %}